name: Deployment

on:
  push:
    branches: [ default ]

jobs:
  build_and_deploy:
    runs-on: ubuntu-20.04

    steps:
    - uses: actions/checkout@v2

    - name: Install Base Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install python3-venv latexmk texlive-latex-recommended texlive-fonts-recommended texlive-latex-extra
        pip3 install poetry git+https://github.com/mmh352/ou-container-builder.git

    - name: Install Dependencies
      run: |
        poetry install --no-dev

    - name: Build the Tutorial
      run: |
        poetry run sphinx-build -b latex source build/latex
        cd build/latex
        latexmk -pdf metadatatutorial.tex
        ls
        cp metadatatutorial.pdf ../../source/_static/
        cd ../../
        poetry run sphinx-build -b html source build/html

    - name: Generate the Dockerfile
      run: |
        ou-container-builder --no-build

    - name: Build and push the Docker image
      uses: docker/build-push-action@v1.1.0
      with:
        username: mmh352
        password: ${{ secrets.DOCKERACCESSTOKEN }}
        repository: mmh352/metadatatutorial-2
        tags: latest
        tag_with_sha: true
        dockerfile: Dockerfile
